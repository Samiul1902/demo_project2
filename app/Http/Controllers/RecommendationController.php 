<?php

namespace App\Http\Controllers;

use App\Models\Booking;
use App\Models\Customer;
use App\Models\Service;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

/**
 * Simple rule-based “AI” stub to simulate FR‑17 personalized recommendations.[file:1]
 */
class RecommendationController extends Controller
{
    /**
     * Return a list of recommended services for the current demo customer.[file:1]
     */
    public function index(Request $request)
    {
        // In this prototype, the first customer record is treated as the current user (FR‑1).[file:1]
        $customer = Customer::first();

        // Base query: only active services.
        $query = Service::where('status', 'Active');

        // If customer has a preferred branch, favour services frequently booked at that branch.
        $preferredBranch = $customer?->preferred_branch;

        // Count how many times each service has been booked overall and by this customer.
        $bookingStats = Booking::select(
                'service_id',
                DB::raw('COUNT(*) as total_count')
            )
            ->groupBy('service_id');

        if ($customer) {
            $bookingStats = $bookingStats->addSelect(
                DB::raw("SUM(CASE WHEN customer_name = '".addslashes($customer->name)."' THEN 1 ELSE 0 END) as customer_count")
            );
        }

        $bookingStats = $bookingStats->get()
            ->keyBy('service_id');

        $services = $query->get()->map(function (Service $s) use ($customer, $preferredBranch, $bookingStats) {
            $stats = $bookingStats->get($s->id);

            $score = 0;

            // Boost services the customer has booked before.
            if ($stats && isset($stats->customer_count)) {
                $score += (int) $stats->customer_count * 5;
            }

            // Boost globally popular services slightly.
            if ($stats && isset($stats->total_count)) {
                $score += (int) $stats->total_count;
            }

            // If the customer has a preferred branch and the service is tagged for that branch in the description/name.
            if ($preferredBranch && str_contains(strtolower($s->name.' '.$s->description), strtolower($preferredBranch))) {
                $score += 3;
            }

            // Fallback: prefer mid-price services.
            if ($s->price >= 500 && $s->price <= 1500) {
                $score += 1;
            }

            $s->recommendation_score = $score;

            return $s;
        });

        $recommended = $services
            ->sortByDesc('recommendation_score')
            ->take(5)
            ->values();

        return view('public.recommendations', [
            'customer'      => $customer,
            'recommended'   => $recommended,
        ]);
    }
}
